(function(){var e=function(t){this.elem=t};e.prototype={defaults:{texts:["此处水印文字"],width:100,height:100,textRotate:-30,textColor:"#e5e5e5",textFont:"14px 微软雅黑"},options:{canvas:[]},init:function(t){$.extend(this.options,this.defaults,t);var e=$("body"),a=this.__createCanvas(e),i=this.__createCanvas(e),s=this.__createCanvas(e),h=this.options,n=h.texts.length;h.deg=h.textRotate*Math.PI/180;this.__calcTextSize(e);var o=Math.ceil(screen.width/h.txts.length/h.width);h.canvasWidth=h.canvasWidth*o;var r=[];while(o--)r=r.concat(h.txts);h.txts=r;var d=h.maxWidth*Math.abs(Math.sin(h.deg))+Math.cos(h.deg)*h.textHeight;if(d>h.height)h.height=d;var c=this.__setCanvasStyle(a,h.canvasWidth,h.height);var v=this.__setCanvasStyle(i,h.canvasWidth,h.height);var l=this.__setCanvasStyle(s,h.canvasWidth,h.height*2,true);this.__drawText(c,h.txts);this.__drawText(v,h.txts.reverse());l.drawImage(a,0,0,h.canvasWidth,h.height);l.drawImage(i,0,h.height,h.canvasWidth,h.height);var x=s.toDataURL("image/png");$(this.elem).css("backgroundImage","url("+x+")")},__createCanvas:function(t){var e=document.createElement("canvas");t.append(e);this.options.canvas.push(e);return e},__calcTextSize:function(n){var o=[],r=0,d=0,c=this.options;$.each(c.texts,function(t,e){var a=$('<span style="font:'+c.textFont+';visibility:hidden;display:inline-block;">'+e+"</span>").appendTo(n);var i=a[0].offsetWidth,s=a[0].offsetHeight;a.remove();o.push({txt:e,width:i,height:s});r=Math.max(r,i);c.textHeight=s;var h=Math.cos(c.deg)*i;d+=(c.width<h?h:c.width)-s*Math.sin(c.deg)});c.txts=o;c.maxWidth=r;c.canvasWidth=d},__setCanvasStyle:function(t,e,a,i){t.width=e;t.height=a;t.style.display="none";var s=t.getContext("2d");if(!i){var h=this.options.deg,n=Math.abs(Math.sin(h));s.rotate(h);var o=n*this.options.height-this.options.textHeight*n;var r=-o*Math.cos(h),d=-o*n;s.translate(r,d*n);s.font=this.options.textFont;s.fillStyle=this.options.textColor;s.textAlign="left";s.textBaseline="Middle"}return s},__drawText:function(h,t){var n=this.options;$.each(t,function(t,e){var a=(n.maxWidth-e.width)/2;var i=n.width*Math.cos(n.deg)*t,s=-i*Math.tan(n.deg)+n.height;h.fillText(e.txt,i+a,s)})},__destory:function(){$.each(this.options.canvas,function(t,e){e.remove();e=null})}};$.fn.watermark=function(t){new e(this).init(t)}})(jQuery);